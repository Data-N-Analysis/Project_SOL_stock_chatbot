import streamlit as st
from news_crawler import crawl_news
from rag_process import get_text_chunks, get_vectorstore, create_chat_chain
from stock_data import get_ticker, get_intraday_data_yahoo, get_daily_stock_data_fdr
from visualization import plot_stock_plotly


def update_period():
    """ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê¸°ê°„ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜)"""
    st.session_state.selected_period = st.session_state.radio_selection


def main():
    st.set_page_config(page_title="Stock Analysis Chatbot", page_icon=":chart_with_upwards_trend:")
    st.title("ê¸°ì—… ì •ë³´ ë¶„ì„ QA Chat")

    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if "conversation" not in st.session_state:
        st.session_state.conversation = None
    if "chat_history" not in st.session_state:
        st.session_state.chat_history = None
    if "processComplete" not in st.session_state:
        st.session_state.processComplete = False
    if "news_data" not in st.session_state:
        st.session_state.news_data = None
    if "company_name" not in st.session_state:
        st.session_state.company_name = None
    if "selected_period" not in st.session_state:
        st.session_state.selected_period = "1day"

    # ì‚¬ì´ë“œë°” ì„¤ì •
    with st.sidebar:
        openai_api_key = st.text_input("OpenAI API Key", key="chatbot_api_key", type="password")
        company_name = st.text_input("ë¶„ì„í•  ê¸°ì—…ëª… (ì½”ìŠ¤í”¼ ìƒì¥)")
        days = st.number_input("ìµœê·¼ ë©°ì¹  ë™ì•ˆì˜ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í• ê¹Œìš”?", min_value=1, max_value=30, value=7)
        process = st.button("ë¶„ì„ ì‹œì‘")

    # ë¶„ì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ
    if process:
        if not openai_api_key or not company_name:
            st.info("OpenAI API í‚¤ì™€ ê¸°ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            st.stop()

        news_data = crawl_news(company_name, days)
        if not news_data:
            st.warning("í•´ë‹¹ ê¸°ì—…ì˜ ìµœê·¼ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            st.stop()

        # ë¶„ì„ ê²°ê³¼ë¥¼ session_stateì— ì €ì¥
        st.session_state.news_data = news_data
        st.session_state.company_name = company_name

        text_chunks = get_text_chunks(news_data)
        vectorstore = get_vectorstore(text_chunks)

        st.session_state.conversation = create_chat_chain(vectorstore, openai_api_key)
        st.session_state.processComplete = True

    # ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìƒë‹¨ì— ì¶œë ¥
    if st.session_state.processComplete and st.session_state.company_name:
        st.subheader(f"ğŸ“ˆ {st.session_state.company_name} ìµœê·¼ ì£¼ê°€ ì¶”ì´")

        # ì„ íƒëœ ê¸°ê°„ì„ ê°•ì œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜
        st.session_state.radio_selection = st.session_state.selected_period
        selected_period = st.radio(
            "ê¸°ê°„ ì„ íƒ",
            options=["1day", "week", "1month", "1year"],
            index=["1day", "week", "1month", "1year"].index(st.session_state.selected_period),
            key="radio_selection",
            on_change=update_period
        )

        if selected_period != st.session_state.selected_period:
            st.session_state.selected_period = selected_period

        st.write(f"ğŸ” ì„ íƒëœ ê¸°ê°„: {st.session_state.selected_period}")

        with st.spinner(f"ğŸ“Š {st.session_state.company_name} ({st.session_state.selected_period}) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."):
            # ì£¼ì‹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            if selected_period in ["1day", "week"]:
                ticker = get_ticker(st.session_state.company_name, source="yahoo")

                if not ticker:
                    st.error("í•´ë‹¹ ê¸°ì—…ì˜ ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ í‹°ì»¤ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    return

                interval = "1m" if st.session_state.selected_period == "1day" else "5m"
                df = get_intraday_data_yahoo(ticker,
                                             period="5d" if st.session_state.selected_period == "week" else "1d",
                                             interval=interval)
            else:
                ticker = get_ticker(st.session_state.company_name, source="fdr")
                if not ticker:
                    st.error("í•´ë‹¹ ê¸°ì—…ì˜ FinanceDataReader í‹°ì»¤ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    return

                df = get_daily_stock_data_fdr(ticker, st.session_state.selected_period)

            # ì£¼ì‹ ì°¨íŠ¸ ì‹œê°í™”
            if df.empty:
                st.warning(
                    f"ğŸ“‰ {st.session_state.company_name} - í•´ë‹¹ ê¸°ê°„({st.session_state.selected_period})ì˜ ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                plot_stock_plotly(df, st.session_state.company_name, st.session_state.selected_period)

        st.markdown("ìµœê·¼ ê¸°ì—… ë‰´ìŠ¤ ëª©ë¡ì„ ë³´ë ¤ë©´ ëˆ„ë¥´ì‹œì˜¤")

    # ë‰´ìŠ¤ ëª©ë¡ í‘œì‹œ
    if st.session_state.processComplete:
        with st.expander("ë‰´ìŠ¤ ë³´ê¸°"):
            news_data = st.session_state.news_data

            # ì²˜ìŒ 10ê°œ ë‰´ìŠ¤ë§Œ í‘œì‹œ
            for i, news in enumerate(news_data[:10]):
                st.markdown(f"- **{news['title']}** ([ë§í¬]({news['link']}))")

            # 'ë”ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ë‚˜ë¨¸ì§€ ë‰´ìŠ¤ í‘œì‹œ
            if len(news_data) > 10:
                if st.button('ë”ë³´ê¸°', key="show_more"):
                    for news in news_data[10:]:
                        st.markdown(f"- **{news['title']}** ([ë§í¬]({news['link']}))")

    # ì±„íŒ… ë¶€ë¶„: ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ëŒ€í™”ê°€ ì´ì–´ì§
    if query := st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."):
        with st.chat_message("user"):
            st.markdown(query)

        with st.chat_message("assistant"):
            with st.spinner("ë¶„ì„ ì¤‘..."):
                result = st.session_state.conversation({"question": query})
                response = result['answer']

                st.markdown(response)
                with st.expander("ì°¸ê³  ë‰´ìŠ¤ í™•ì¸"):
                    for doc in result['source_documents']:
                        st.markdown(f"- [{doc.metadata['source']}]({doc.metadata['source']})")


if __name__ == '__main__':
    main()